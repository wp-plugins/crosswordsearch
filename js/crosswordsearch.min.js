/*
crosswordsearch Wordpress plugin v0.4.1
Copyright Claus Colloseus 2014 for RadiJojo.de

This program is free software: Redistribution and use, with or
without modification, are permitted provided that the following
conditions are met:
 * If you redistribute this code, either as source code or in
   minimized, compacted or obfuscated form, you must retain the
   above copyright notice, this list of conditions and the
   following disclaimer.
 * If you modify this code, distributions must not misrepresent
   the origin of those parts of the code that remain unchanged,
   and you must retain the above copyright notice and the following
   disclaimer.
 * If you modify this code, distributions must include a license
   which is compatible to the terms and conditions of this license.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
*/
var customSelectElement=angular.module("customSelectElement",[]);customSelectElement.directive("cseDefault",function(){return{scope:{value:"="},template:function(a,b){return"{{"+(b.cseDefault||"value.value || value")+"}}"}}}),customSelectElement.directive("cseOption",["$compile",function(a){return{scope:{value:"="},link:function(b,c,d){b.select=function(a){b.$emit("cseSelect",d.name,a)},d.$observe("value",function(){var e;angular.isObject(b.value)&&b.value.group?(e='<dl cse-select="'+d.name+'.sub" cse-model="head" cse-options="value.group" is-group ',e+=angular.isDefined(d.expr)?'display="'+d.expr+'"':'template="'+d.templ+'"',angular.isDefined(d.isMenu)&&(e+=' is-menu="'+b.value.menu+'"'),e+="></dl>",c.html(e)):(e="<div ng-click=",e+=angular.isObject(b.value)&&angular.isDefined(b.value.value)?'"select(value.value)" ':'"select(value)" ',e+=d.templ,angular.isDefined(d.expr)&&(e+='="'+d.expr+'"'),e+=' value="value"></div>',c.html(e)),a(c.contents())(b)})}}}]),customSelectElement.directive("cseSelect",["$document","$timeout",function(a,b){return{restrict:"A",scope:{options:"=cseOptions",model:"=cseModel"},link:function(c,d,e){function f(b){var e=angular.element(b.target);do{if(g(e,d))return;e=e.parent()}while(e.length&&!g(a,e));c.$apply("visible = false")}function g(a,b){return a[0]===b[0]}var h;d.addClass("cse select"),c.isDefined=angular.isDefined,angular.isDefined(e.isMenu)?(c.model=e.isMenu,c.setModel=!1):c.setModel=!0,c.visible=!1,c.$watch("visible",function(b){b?a.bind("click",f):a.unbind("click",f)}),c.hideLeave=function(){h=b(function(){c.visible=!1},200)},c.showEnter=function(){c.visible=!0,h&&b.cancel(h)},d.on("$destroy",function(){a.unbind("click",f),h&&b.cancel(h)}),c.$on("cseSelect",function(a,b,d){c.visible=!1,c.setModel&&(c.model=d)})},template:function(a,b){var c="cse-default",d=!1;angular.isDefined(b.template)?c=b.template:angular.isDefined(b.display)&&(d=!0);var e="<dt ";return e+=angular.isDefined(b.isGroup)?'ng-mouseenter="showEnter()" ng-mouseleave="hideLeave()"':'ng-click="visible=!visible"',e+='><div ng-show="isDefined(model)" '+c,d&&(e+='="'+b.display+'"'),e+=' value="model" is-current></div><a class="btn"></a></dt><dd',angular.isDefined(b.isGroup)&&(e+=' ng-mouseenter="showEnter()" ng-mouseleave="hideLeave()"'),e+=' ng-show="visible"><ul><li ng-repeat="opt in options | orderBy:\'order\'" cse-option name="'+b.cseSelect+'" model="'+b.cseModel+'" value="opt" templ="'+c+'"',d&&(e+=' expr="'+b.display+'"'),angular.isDefined(b.isMenu)&&(e+=" is-menu"),e+="></li></ul></dd>"}}}]);var crwApp=angular.module("crwApp",["ngRoute","qantic.angularjs.stylemodel","customSelectElement"]);crwApp.factory("reduce",function(){return function(a,b,c){return angular.forEach(a,function(a,d){b=c.apply(a,[b,a,d])}),b}}),crwApp.factory("basics",["reduce",function(a){var b=0,c=a(crwBasics.letterDist,"",function(a,c,d){b+=c;for(var e=0;c>e;e++)a+=d;return a});return{colors:["black","red","green","blue","orange","violet","aqua"],dimensions:crwBasics.dimensions,pluginPath:crwBasics.pluginPath,randomColor:function(a){var b;do b=this.colors[Math.floor(7*Math.random())];while(b===a);return b},randomLetter:function(){var a=Math.floor(Math.random()*b);return c.slice(a,a+1)},letterRegEx:new RegExp(crwBasics.letterRegEx),directionMapping:{"down-right":{end:"up-left",middle:"diagonal-down",left:"corner-up-right",right:"corner-down-left"},"up-left":{end:"down-right",middle:"diagonal-down",left:"corner-up-right",right:"corner-down-left"},"up-right":{end:"down-left",middle:"diagonal-up",left:"corner-down-right",right:"corner-up-left"},"down-left":{end:"up-right",middle:"diagonal-up",left:"corner-down-right",right:"corner-up-left"},down:{end:"up",middle:"vertical"},up:{end:"down",middle:"vertical"},right:{end:"left",middle:"horizontal"},left:{end:"right",middle:"horizontal"}},localize:function(a){return crwBasics.locale[a]||a}}}]),crwApp.constant("nonces",{}),crwApp.factory("ajaxFactory",["$http","$q","nonces",function(a,b,c){a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded";var d={transformRequest:jQuery.param,method:"POST",url:crwBasics.ajaxUrl};jQuery(document).on("heartbeat-tick",function(a,b){b["wp-auth-check"]===!1&&angular.forEach(c,function(a,b){delete c[b]})});var e=function(a){return b.reject(a.heartbeat?a:{error:"server error",debug:["status "+a.status]})},f=function(a,d){var e=!1;return"object"!=typeof a.data?e={error:"malformed request"}:a.data.error&&(e=a.data),e?b.reject(e):(a.data.nonce&&(c[d]=a.data.nonce),a.data)},g=function(b,e){var f=angular.extend({_crwnonce:c[e]},b),g=angular.extend({data:f},d);return a(g)};return{setNonce:function(a,b){c[b]=a},http:function(a,d){return c[d]?g(a,d).then(function(a){return f(a,d)},e):b.reject({heartbeat:!0})}}}]),crwApp.factory("crosswordFactory",["basics","reduce","ajaxFactory",function(a,b,c){function d(){var d="crossword",e="edit",f={},g=1,h=3,i=[],j="",k=!1,l=function(){angular.extend(f,{name:"",description:"",author:"",size:{width:10,height:10},table:[],words:{},solution:{},level:g}),n(f.size.height,!1)},m=function(a){switch(a){case"dir":return!(1&f.level);case"sol":return!(2&f.level)}},n=function(a,b){if(a>0)for(var c=0;a>c;c++){var d=[];o(d,f.size.width,!1),b?f.table.unshift(d):f.table.push(d)}else f.table.splice(b?0:f.table.length+a,-a);b&&angular.forEach(f.words,function(b){b.start.y+=a,b.stop.y+=a})},o=function(a,b,c){if(b>0)for(var d=0;b>d;d++){var e={letter:null};c?a.unshift(e):a.push(e)}else a.splice(c?0:a.length+b,-b)},p=function(a,b){for(var c=0;c<f.table.length;c++)o(f.table[c],a,b);b&&angular.forEach(f.words,function(b){b.start.x+=a,b.stop.x+=a})},q=function(a){angular.forEach(f.table,function(b,c){angular.forEach(b,function(b,d){a.call(b,c,d)})})};this.getCrosswordData=function(){return f},this.getNamesList=function(){return i},this.getLevelList=function(){for(var a=[],b=0;h>=b;b++)a.push(b);return a},this.setProject=function(a,b,f,g){j=a,k=g,b&&c.setNonce(b,d),f&&c.setNonce(f,e)},this.loadDefault=l,this.loadCrosswordData=function(a){return c.http({action:"get_crossword",project:j,name:a,restricted:k},d).then(function(a){return g=a.default_level,h=a.maximum_level,i=a.namesList,angular.isObject(a.crossword)?(angular.extend(f,a.crossword),m("sol")&&(f.solution=angular.copy(f.words))):l(),!0})},this.saveCrosswordData=function(a,b,d,g){f.solution={};var h={action:"save_crossword",method:b,project:j,restricted:k,crossword:angular.toJson(f),username:d,password:g};return"update"===b?(h.old_name=a,h.name=f.name):h.name=a,c.http(h,e).then(function(a){return i=a.namesList,!0})},this.getHighId=function(){return b(f.words,0,function(a,b){return Math.max(a,b.ID)})},this.randomColor=function(){var b=this.getHighId();return a.randomColor(b>0?f.words[b].color:void 0)},this.deleteWord=function(a,b){f[b][a]&&delete f[b][a]},this.randomizeEmptyFields=function(){q(function(){this.letter||(this.letter=a.randomLetter())})},this.emptyAllFields=function(){q(function(){this.letter=null})},this.setWord=function(a){return angular.forEach(a.fields,function(a){a.word=f.table[a.y][a.x]}),f.words[a.ID]=a},this.getLevelRestriction=m,this.probeWord=function(a){var b=a;return angular.forEach(b.fields,function(a){a.word=f.table[a.y][a.x]}),b.solved=!1,angular.forEach(f.words,function(a){angular.equals(a.start,b.start)&&angular.equals(a.stop,b.stop)&&(b=a,a.solved=!0)}),b.markingId=a.ID,f.solution[b.ID]=b},this.testWordBoundaries=function(a){var b=[];return angular.forEach(f.words,function(c,d){(Math.min(c.start.x,c.stop.x)<-a.left||Math.max(c.start.x,c.stop.x)>=f.size.width+a.right||Math.min(c.start.y,c.stop.y)<-a.top||Math.max(c.start.y,c.stop.y)>=f.size.height+a.bottom)&&b.push(parseInt(d,10))}),b},this.testDirection=function(){var a=[];return angular.forEach(f.words,function(b,c){"right"!==b.direction&&"down"!==b.direction&&a.push(parseInt(c,10))}),a},this.changeSize=function(a,b){angular.forEach(b,function(a){this.deleteWord(a,"words")},this);var c=angular.copy(f.size);0!==a.left&&(p(a.left,!0),c.width+=a.left),0!==a.right&&(p(a.right,!1),c.width+=a.right),0!==a.top&&(n(a.top,!0),c.height+=a.top),0!==a.bottom&&(n(a.bottom,!1),c.height+=a.bottom),f.size=c}}return{getCrw:function(){return new d}}}]),crwApp.factory("markerFactory",["basics",function(a){function b(){function b(a,b,c,e){null!=e&&(null==d[b]&&(d[b]={}),null==d[b][c]&&(d[b][c]={}),d[b][c][a.ID]={marking:a,img:e})}function c(c,d){var e=a.directionMapping[c.direction];angular.forEach(c.fields,function(a,f){if(0===f){if(b(c,a.x,a.y,c.direction),"origin"===c.direction)return;d?b(c,a.x-1,a.y,e.left):b(c,a.x+1,a.y,e.right)}else f===c.fields.length-1?(b(c,a.x,a.y,e.end),d?b(c,a.x+1,a.y,e.right):b(c,a.x-1,a.y,e.left)):(b(c,a.x,a.y,e.middle),b(c,a.x-1,a.y,e.left),b(c,a.x+1,a.y,e.right))})}var d={};this.setNewMarkers=function(a){var b,d=a.start,e=a.stop,f=e.x-d.x,g=e.y-d.y,h=0>f||0===f&&0>g;if(this.deleteMarking(a.ID),a.fields=[],f*g>0)for(a.direction=h?"up-left":"down-right",b=0;Math.abs(b)<=Math.abs(e.x-d.x);h?b--:b++)a.fields.push({x:d.x+b,y:d.y+b});else if(0>f*g)for(a.direction=h?"down-left":"up-right",b=0;Math.abs(b)<=Math.abs(e.x-d.x);h?b--:b++)a.fields.push({x:d.x+b,y:d.y-b});else if(0===f&&0===g)a.direction="origin",a.fields.push({x:d.x,y:d.y});else if(0===f)for(a.direction=h?"up":"down",b=0;Math.abs(b)<=Math.abs(e.y-d.y);h?b--:b++)a.fields.push({x:d.x,y:d.y+b});else for(a.direction=h?"left":"right",b=0;Math.abs(b)<=Math.abs(e.x-d.x);h?b--:b++)a.fields.push({x:d.x+b,y:d.y});c(a,h)},this.exchangeMarkers=function(a,b,c){angular.forEach(a,function(a){d[a.x][a.y][b].marking.color=c})},this.redrawMarkers=function(a){angular.forEach(a,function(a){var b=0,d=0,e=a.start,f=a.stop,g=f.x<e.x||f.x===e.x&&f.y<e.y;this.deleteMarking(a.ID),a.fields.length&&(b=e.x-a.fields[0].x,d=e.y-a.fields[0].y),angular.forEach(a.fields,function(a){a.x+=b,a.y+=d}),c(a,g)},this)},this.getMarks=function(a,b){return null==d[a]||null==b?void 0:d[a][b]},this.deleteMarking=function(a){angular.forEach(d,function(b){angular.forEach(b,function(b){delete b[a]})})},this.deleteAllMarking=function(){d={}}}return{getMarkers:function(){return new b}}}]),crwApp.directive("crwHelpFollow",["$document",function(a){return{link:function(b){var c={},d=a.find(".contextual-help-tabs li, .help-tab-content");c.capabilities=d.filter("[id*=crw-help-tab-options]"),c.editor=d.filter("[id*=crw-help-tab-projects]"),c.review=d.filter("[id*=crw-help-tab-review]"),b.$watch("activeTab",function(a){var b=/(capabilities|editor|review)/.exec(a)[0];angular.forEach(c,function(a,c){c===b?a.addClass("active"):a.removeClass("active")})})}}}]),crwApp.directive("crwBindTrusted",["$sce",function(){return{link:function(a,b,c){a.$watch(c.crwBindTrusted,function(a){b.html(a)})}}}]),crwApp.controller("AdminController",["$scope","$location","qStore","ajaxFactory","crosswordFactory",function(a,b,c,d,e){a.crw=e.getCrw(),a.immediateStore=c.addStore(),a.setActive=function(c){a.activeTab=c,b.path(a.activeTab)},a.prepare=function(c,e){d.setNonce(e,"settings"),a.setActive(!a.activeTab&&/^\/(capabilities|editor|review)/.test(b.path())?b.path():c)},a.setError=function(c){c?c.heartbeat?b.path(""):a.globalError=c:a.globalError=null}}]),crwApp.directive("crwDimension",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.unshift(function(a){var b=parseInt(a,10);return isNaN(b)||0>b||b.toString()!==a?void d.$setValidity("dimension",!1):(d.$setValidity("dimension",!0),b)})}}}),crwApp.controller("OptionsController",["$scope","ajaxFactory",function(a,b){var c="options",d=function(b){a.capsEdit.$setPristine(),a.dimEdit&&a.dimEdit.$setPristine(),a.setError(!1),a.capabilities=b.capabilities,a.dimensions=b.dimensions};a.update=function(e){var f={action:"update_crw_"+e};f[e]=angular.toJson(a[e]),b.http(f,c).then(d,a.setError)},a.prepare=function(e){b.setNonce(e,c),b.http({action:"get_crw_capabilities"},c).then(d,a.setError)}}]),crwApp.controller("EditorController",["$scope","$filter","ajaxFactory",function(a,b,c){var d="editors";a.levelList=function(b){var c,d,e=[];"default"===b?(c=0,d=a.currentProject.maximum_level):(c=Math.max(a.currentProject.default_level,a.currentProject.used_level),d=3);for(var f=c;d>=f;f++)e.push(f);return e},a.getProjectList=function(b){var c=[];return angular.forEach(a.admin.projects,function(a){a.name!==b&&c.push(a.name)}),c},a.currentEditors=[];var e=function(c,d){a.admin=c,angular.forEach(a.admin.projects,function(a){a.pristine=!0}),a.selectedProject=d?jQuery.grep(a.admin.projects,function(a){return a.name===d})[0]:b("orderBy")(a.admin.projects,"name")[0],f(),a.editorsPristine=!0};a.$watch("projectMod.$pristine",function(b){var c=!0;angular.forEach(["name","defaultL","maximumL"],function(b){c&=a.projectMod[b].$pristine}),!b&&c&&a.projectMod.$setPristine()}),a.addProject=function(){a.selectedProject=null},a.$watch("selectedProject",function(b){b?(a.currentProject=angular.copy(b),a.currentEditors=angular.copy(b.editors)):(a.currentProject={name:"",default_level:1,maximum_level:3,used_level:0,editors:[]},a.currentEditors=[]),a.projectMod.$setPristine(),a.editorsPristine=!0,a.setError(!1)}),a.abortProject=function(){a.selectedProject||(a.selectedProject=b("orderBy")(a.admin.projects,"name")[0]),a.currentProject=angular.copy(a.selectedProject),a.projectMod.$setPristine(),a.setError(!1)},a.saveProject=function(){c.http({action:"save_project",method:a.selectedProject?"update":"add",project:a.selectedProject?a.selectedProject.name:void 0,new_name:a.currentProject.name,default_level:a.currentProject.default_level,maximum_level:a.currentProject.maximum_level},d).then(function(b){e(b,a.currentProject.name)},a.setError)},a.deleteProject=function(){var b={which:"remove_project",project:a.selectedProject.name};a.immediateStore.newPromise("actionConfirmation",b).then(function(){c.http({action:"save_project",method:"remove",project:a.selectedProject.name},d).then(e,a.setError)})},a.filtered_users=[];var f=function(){a.admin&&(a.filtered_users=jQuery.grep(a.admin.all_users,function(b){return jQuery.inArray(b.user_id,a.currentEditors)<0}),jQuery.inArray(a.selectedEditor,a.currentEditors)<0&&(a.selectedEditor=b("orderBy")(a.currentEditors,a.getUserName)[0]),jQuery.inArray(a.selectedUser,a.filtered_users)<0&&(a.selectedUser=b("orderBy")(a.filtered_users,"user_name")[0]),a.setError(!1))};a.$watchCollection("currentEditors",f);var g=function(b){a.currentEditors.push(b.user_id)},h=function(b){return jQuery.grep(a.admin.all_users,function(a){return a.user_id===b})[0]};a.getUserName=function(a){return h(a).user_name},a.addAll=function(){angular.forEach(a.filtered_users,g),a.editorsPristine=!1},a.addOne=function(){var b=a.selectedUser.user_id;g(a.selectedUser),a.editorsPristine=!1,a.selectedEditor=b},a.removeAll=function(){a.currentEditors.splice(0,a.currentEditors.length),a.editorsPristine=!1},a.removeOne=function(){var b=jQuery.inArray(a.selectedEditor,a.currentEditors),c=h(a.selectedEditor);a.currentEditors.splice(b,1),a.editorsPristine=!1,a.selectedUser=c},a.abortEditors=function(){a.currentEditors=angular.copy(a.selectedProject.editors),a.setError(!1),a.editorsPristine=!0},a.saveEditors=function(){c.http({action:"update_editors",project:a.selectedProject.name,editors:angular.toJson(a.currentEditors)},d).then(function(b){e(b,a.selectedProject.name)},a.setError)},a.prepare=function(b){c.setNonce(b,d),c.http({action:"get_admin_data"},d).then(e,a.setError)}}]),crwApp.directive("crwOptionClick",function(){return{link:function(a,b,c){b.on("click","option",function(){a.$apply(function(){a.activateGroup(c.crwOptionClick)})})}}}),crwApp.controller("ReviewController",["$scope","$filter","ajaxFactory",function(a,b,c){var d="review";a.selectedCrossword={confirmed:null,pending:null},a.activeGroup="confirmed";var e=function(c,d){var e;a.projects=c.projects,d&&(e=jQuery.grep(a.projects,function(a){return a.name===d})[0]),a.selectedProject=e?e:b("orderBy")(a.projects,"name")[0],a.setError(!1)};a.deleteCrossword=function(b){var f={which:"delete_crossword",crossword:a.selectedCrossword[b],project:a.selectedProject.name};a.immediateStore.newPromise("actionConfirmation",f).then(function(){c.http({action:"delete_crossword",project:a.selectedProject.name,name:a.selectedCrossword[b]},d).then(function(b){e(b,a.selectedProject.name)},a.setError)})},a.confirm=function(){var f=a.selectedCrossword.pending,g={which:"approve_crossword",crossword:f,project:a.selectedProject.name};a.immediateStore.newPromise("actionConfirmation",g).then(function(){c.http({action:"approve_crossword",project:a.selectedProject.name,name:f},d).then(function(c){e(c,a.selectedProject.name),a.selectedCrossword.confirmed=f,a.selectedCrossword.pending=b("orderBy")(a.selectedProject.pending,"toString()")[0],a.activateGroup("confirmed")},a.setError)})},a.activateGroup=function(b){a.activeGroup=b,a.previewCrossword=a.selectedCrossword[b]},a.$watch("selectedProject",function(c){c&&(a.preview&&a.$broadcast("previewProject",c.name),angular.forEach(a.selectedCrossword,function(d,e){(!d||jQuery.inArray(d,c[e])<0)&&(a.selectedCrossword[e]=b("orderBy")(c[e],"toString()")[0])}))}),a.$watch("preview",function(b){b&&a.selectedProject&&a.$evalAsync(function(){a.$broadcast("previewProject",a.selectedProject.name),a.previewCrossword=a.selectedCrossword[a.activeGroup],a.$broadcast("previewCrossword",a.previewCrossword)})}),a.$watchCollection("selectedCrossword",function(b){a.previewCrossword=b[a.activeGroup]}),a.$watch("previewCrossword",function(b){a.preview&&a.$broadcast("previewCrossword",b)}),a.prepare=function(b,f){c.setNonce(b,"crossword"),c.setNonce(f,d),c.http({action:"list_projects_and_riddles"},d).then(e,a.setError)}}]),crwApp.config(["$routeProvider","nonces",function(a,b){function c(a){var c=crwBasics.ajaxUrl+"?action=get_option_tab&tab=";return b.settings?c+a+"&_crwnonce="+b.settings:c+"invalid"}var d="";a.when("/capabilities",{templateUrl:function(){return d="/capabilities",c("capabilities")}}).when("/editor",{templateUrl:function(){return d="/editor",c("editor")}}).when("/review",{templateUrl:function(){return d="/review",c("review")}}).otherwise({redirectTo:function(){return d}})}]),crwApp.directive("crwCatchMouse",["$document",function(a){return{link:function(b,c,d){var e=function(c){angular.isDefined(d.preventDefault)&&c.preventDefault(),a.bind("mouseup",f),b[d.down]()},f=function(c){angular.isDefined(d.preventDefault)&&c.preventDefault(),a.unbind("mouseup",f),b.$apply(b[d.up]())};c.bind("mousedown",e),c.on("$destroy",function(){c.unbind("mousedown",e),a.unbind("mouseup",f)})}}}]),crwApp.directive("crwMenu",["$compile",function(){return{scope:{value:"="},link:function(a,b){a.$watch("value",function(){b.attr("title",a.value.title)})},template:'<span crw-bind-trusted="value.display || value"></span>'}}]),crwApp.controller("CrosswordController",["$scope","qStore","basics","crosswordFactory",function(a,b,c,d){function e(b){jQuery.grep(a.commandList,function(a){return"load"===a.value})[0].group=b}a.crw||(a.crw=d.getCrw()),a.immediateStore||(a.immediateStore=b.addStore()),a.commandState="full",a.highlight=[],a.count={words:0,solution:0},a.levelList=a.crw.getLevelList(),a.commands={"new":"load()",load:"group",update:'save("update")',insert:'save("insert")',reload:"load(loadedName)"},a.prepare=function(b,d,e,f,g){a.crw.setProject(b,d,e,g),g&&(a.commandState="restricted",delete a.commands.load,delete a.commands.insert),a.commandList=jQuery.map(a.commands,function(a,b){var d=c.localize(b);return d.value=b,"load"===b&&(d.menu=d.display,d.group=[]),d});var h=a.$on("immediateReady",function(){a.load(f),h()})},a.$on("cseSelect",function(b,c,d){switch(b.stopPropagation(),c){case"command":a.$evalAsync(a.commands[d]);break;case"command.sub":case"load":a.$evalAsync('load("'+d+'")');break;case"level":var e=a.crw.testDirection(),f=a.crosswordData.level;if(!(1&d)&&e.length){a.setHighlight(e);var g={count:e.length,level:d};a.immediateStore.newPromise("invalidDirections",g).then(function(){angular.forEach(e,function(b){a.crw.deleteWord(b,"words")})},function(){a.$evalAsync("crosswordData.level="+f)})["finally"](function(){a.setHighlight([])})}}}),a.$on("previewProject",function(b,c){a.crw.setProject(c)}),a.wordsToArray=function(a){var b=[];return angular.forEach(a,function(a){b.push(a)}),b};var f=function(){"full"===a.commandState&&(a.namesInProject=a.crw.getNamesList(),e(a.namesInProject)),a.loadedName=a.crosswordData.name,a.setHighlight([])},g=function(){a.crosswordData=a.crw.getCrosswordData(),a.levelList=a.crw.getLevelList(),f(),a.count.words=0,angular.forEach(a.crosswordData.words,function(b){a.count.words++,a.crw.setWord(b)}),a.count.solution=0};a.setHighlight=function(b){a.highlight=b},a.load=function(b){a.loadError=null,b||"string"==typeof b?a.immediateStore.newPromise("loadCrossword",b).then(g,function(b){a.loadError=b}):(a.crw.loadDefault(),g())},a.$on("previewCrossword",function(b,c){a.load(c)}),a.restart=function(){a.crw.getLevelRestriction("sol")?angular.forEach(a.crosswordData.solution,function(a){a.solved=!1}):a.crosswordData.solution={},a.count.solution=0},a.$watch("count.solution",function(b){b>0&&b===a.count.words&&a.immediateStore.newPromise("solvedCompletely")}),a.save=function(b){a.crosswordData.name||(b="insert"),a.immediateStore.newPromise("saveCrossword",b).then(f)},a.randomize=function(){a.crw.randomizeEmptyFields()},a.empty=function(){a.crw.emptyAllFields()}}]),crwApp.controller("SizeController",["$scope","$document","basics","StyleModelContainer",function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o=c.dimensions.field+c.dimensions.fieldBorder,p=c.dimensions.handleOutside+c.dimensions.tableBorder,q=c.dimensions.handleOutside+c.dimensions.handleInside,r=function(b,d){g=e=0,h=b*o,f=d*o,i=j=0,k=b*o,m=k+2*c.dimensions.tableBorder-c.dimensions.fieldBorder,l=n=d*o,n=l+2*c.dimensions.tableBorder-c.dimensions.fieldBorder,a.modLeft.transform(g,0),a.modTop.transform(0,e),a.modRight.transform(h,0),a.modBottom.transform(0,f)};d.add("size-left",-1/0,(a.crosswordData.size.height-3)*o,0,0),d.add("size-top",0,0,-1/0,(a.crosswordData.size.width-3)*o),d.add("size-right",5*o,1/0,0,0),d.add("size-bottom",0,0,5*o,1/0),a.modLeft=d.get("size-left"),a.modTop=d.get("size-top"),a.modRight=d.get("size-right"),a.modBottom=d.get("size-bottom"),r(a.crosswordData.size.width,a.crosswordData.size.height),a.$watch("crosswordData.size",function(a){r(a.width,a.height)}),a.modLeft.addStyle("size-left",function(b){g=b,i=Math.ceil(g/o)*o,k=Math.floor((h-i)/o)*o,a.modRight&&(a.modRight.minx=Math.floor(g/o)*o+3*o)}),a.modLeft.addStyle("handle-left",function(){return{left:g-i-p+"px",width:i-g+q+"px"}}),a.modTop.addStyle("size-top",function(b,c){e=c,j=Math.ceil(e/o)*o,l=Math.floor((f-j)/o)*o,a.modBottom&&(a.modBottom.miny=Math.floor(e/o)*o+3*o)}),a.modTop.addStyle("handle-top",function(){return{top:e-j-p+"px",height:j-e+q+"px"}}),a.modRight.addStyle("size-right",function(b){h=b,k=Math.floor((h-i)/o)*o,a.modLeft&&(a.modLeft.maxx=Math.floor(h/o)*o-3*o)}),a.modRight.addStyle("handle-right",function(){return{right:i+k-h-p+"px",width:h-i-k+q+"px"}}),a.modBottom.addStyle("size-bottom",function(b,c){f=c,l=Math.floor((f-j)/o)*o,a.modTop&&(a.modTop.maxy=Math.floor(f/o)*o-3*o)}),a.modBottom.addStyle("handle-bottom",function(){return{bottom:j+l-f-p+"px",height:f-j-l+q+"px"}}),a.styleCrossword=function(){return{width:m+"px",height:n+40+"px"}},a.styleGridSize=function(){return{left:i+"px",width:k-c.dimensions.fieldBorder+"px",top:j+"px",height:l-c.dimensions.fieldBorder+"px"}},a.styleShift=function(){return{left:-(i+c.dimensions.fieldBorder)+"px",top:-(j+c.dimensions.fieldBorder)+"px"}},a.styleExtras=function(){return{left:i+"px",top:j+l+p+"px"}};var s,t=function(){return{left:-i/o,right:(i+k)/o,top:-j/o,bottom:(j+l)/o}};a.startResize=function(){s=t()},a.stopResize=function(){var b=t();if(angular.equals(s,b))r(s.right+s.left,s.bottom+s.top);else{var c={left:b.left-s.left,right:b.right-s.right,top:b.top-s.top,bottom:b.bottom-s.bottom},d=a.crw.testWordBoundaries(c);d.length?(a.setHighlight(d),a.immediateStore.newPromise("invalidWords",d).then(function(){a.crw.changeSize(c,d)},function(){r(s.right+s.left,s.bottom+s.top)})["finally"](function(){a.setHighlight([])})):a.crw.changeSize(c,d)}}}]),crwApp.directive("crwSetFocus",function(){return{link:function(a,b){b.on("mousemove",function(a){a.preventDefault()}),a.$on("setFocus",function(c,d,e){d===a.line&&e===a.column&&b[0].focus()})}}}),crwApp.directive("crwIndexChecker",function(){return{link:function(a,b,c){a.$watch("$index",function(b){a[c.crwIndexChecker]=b})}}}),crwApp.controller("TableController",["$scope","basics","markerFactory",function(a,b,c){function d(b){var c=e.start.x-b.x,d=e.start.y-b.y;return a.crw.getLevelRestriction("dir")?0===c&&0>=d||0===d&&0>=c:Math.abs(c)===Math.abs(d)||0===c||0===d}var e,f,g,h=!1;a.markers=c.getMarkers(),a.setMode=function(b){f=b,g=a.crosswordData.name,e={ID:a.crw.getHighId()},"build"===f&&a.$watch("crosswordData.words",function(b,c){if(g!==a.crosswordData.name)return void(g=a.crosswordData.name);var d,e=0;angular.forEach(c,function(c,f){e++,b[f]?d=!0:a.markers.deleteMarking(f)}),(d||0===e)&&a.markers.redrawMarkers(a.crosswordData.words)},!0),"solve"===f&&a.$watch("crosswordData.solution",function(b,c){return g!==a.crosswordData.name?void(g=a.crosswordData.name):(angular.forEach(c,function(c,d){b[d]&&b[d].solved||a.markers.deleteMarking(c.markingId)}),void angular.forEach(b,function(b,d){(!c[d]||!c[d].solved&&b.solved)&&a.markers.exchangeMarkers(b.fields,e.ID,b.color)}))},!0)},a.$watch("crosswordData.name",function(){a.markers.deleteAllMarking(),e={ID:a.crw.getHighId()},"solve"!==f&&a.markers.redrawMarkers(a.crosswordData.words)}),a.getMarks=function(b,c){return a.markers.getMarks(c,b)},a.getImgClass=function(a){return[a.img,a.marking.color]},a.activate=function(b,c){a.$broadcast("setFocus",b,c)},a.startMark=function(){h=!0,e={ID:e.ID+1},e.color="build"===f?a.crw.randomColor():"grey"},a.stopMark=function(){if(h)if(h=!1,angular.equals(e.start,e.stop))a.markers.deleteMarking(e.ID);else if("build"===f)a.crw.setWord(e);else{var b=a.crw.probeWord(e);b.solved?a.count.solution++:(a.setHighlight([b.ID]),a.immediateStore.newPromise("falseWord",b.fields).then(function(){a.crw.deleteWord(e.ID,"solution"),a.setHighlight([])}))}},a.intoField=function(b,c){var f={x:c,y:b};h&&e.start&&d(f)&&(e.stop=f,a.markers.setNewMarkers(e))},a.outofField=function(b,c){h&&!e.start&&(e.start=e.stop={x:c,y:b},a.markers.setNewMarkers(e))},a.move=function(a){switch(a.which){case 8:case 46:this.field.letter=null,a.preventDefault(),a.stopPropagation();break;case 37:this.column>0&&this.activate(this.line,this.column-1),a.preventDefault(),a.stopPropagation();break;case 38:this.line>0&&this.activate(this.line-1,this.column),a.preventDefault(),a.stopPropagation();break;case 39:this.column<this.row.length-1&&this.activate(this.line,this.column+1),a.preventDefault(),a.stopPropagation();break;case 40:this.line<this.crosswordData.table.length-1&&this.activate(this.line+1,this.column),a.preventDefault(),a.stopPropagation()}var c=String.fromCharCode(a.which);b.letterRegEx.test(c)&&a.stopPropagation()},a.type=function(a){var c=String.fromCharCode(a.which);b.letterRegEx.test(c)&&(this.field.letter=c.toUpperCase(),a.preventDefault(),a.stopPropagation())}}]),crwApp.directive("colorSelect",["basics",function(a){return{scope:{value:"="},link:function(b){b.localize=a.localize},template:'<img title="{{localize(value)}}" ng-src="'+a.pluginPath+'images/bullet-{{value}}.png">'}}]),crwApp.filter("joinWord",["reduce",function(a){return function(b){return a(b,"",function(a,b){return a+(b.word.letter||"_")})}}]),crwApp.controller("EntryController",["$scope","$filter","basics",function(a,b,c){a.colors=c.colors,a.isHighlighted=function(){for(var b=0;b<a.highlight.length;b++)if(a.highlight[b]===a.word.ID)return!0;return!1},a.deleteWord=function(b){a.crw.deleteWord(b,"words")},a.localize=c.localize,a.$on("select",function(a){a.stopPropagation()})}]),crwApp.factory("qStore",["$q",function(a){function b(){var b={};this.register=function(a,c){b[a]||(b[a]=[]),b[a].push(c)},this.newPromise=function(c,d){var e=a.defer();return b[c]&&angular.forEach(b[c],function(a){a(e,d)}),e.promise}}return{addStore:function(){return new b}}}]),crwApp.directive("crwAddParsers",function(){return{require:"ngModel",link:function(a,b,c,d){var e=/\s+/,f=c.crwAddParsers.split(e);if(jQuery.inArray("unique",f)>=0){var g=c.crwUnique.split(e);d.$parsers.unshift(function(b){if(void 0===b)return b;var c,e,f=b;for(e=0;e<g.length;e++)c=a.$eval(g[e]),jQuery.isArray(c)?jQuery.inArray(b,c)>=0&&(f=void 0):"object"!=typeof c?"string"!=typeof c||c!==b||(f=void 0):c.hasOwnProperty(b)&&(f=void 0);return d.$setValidity("unique",void 0!==f),f})}jQuery.inArray("sane",f)>=0&&d.$parsers.unshift(function(a){a=a.replace(e," ");var b=a.replace(/<|%[a-f0-9]{2}/,"");return b===a?(d.$setValidity("sane",!0),a):void d.$setValidity("sane",!1)})}}}),crwApp.directive("crwHasPassword",function(){return{link:function(a,b){b.find("input[type=submit]").on("click",function(){a.password=null})}}}),crwApp.controller("ImmediateController",["$scope",function(a){var b;a.immediate=null,a.finish=function(c){a.saveError=void 0,a.saveDebug=void 0,a.immediate=null,c?b.resolve():b.reject()},a.immediateStore.register("loadCrossword",function(c,d){b=c,a.message={which:"load_crossword",buttons:{}},a.immediate="dialogue",a.crw.loadCrosswordData(d).then(a.finish,function(c){a.immediate=null,b.reject(c)})}),a.immediateStore.register("invalidWords",function(c,d){b=c,a.message={which:"invalid_words",count:d.length,buttons:{"delete":!0,abort:!0}},a.immediate="dialogue"}),a.immediateStore.register("invalidDirections",function(c,d){b=c,a.message={which:"invalid_directions",count:d.count,level:d.level,buttons:{"delete":!0,abort:!0}},a.immediate="dialogue"}),a.immediateStore.register("saveCrossword",function(c,d){b=c,a.immediate="save_crossword",a.action=d}),a.upload=function(b,c){a.crw.saveCrosswordData("update"===a.action?a.loadedName:a.crosswordData.name,a.loadedName===a.crosswordData.name?"update":a.action,b,c).then(a.finish,function(b){a.saveError=b.error,a.saveDebug=b.debug})},a.immediateStore.register("falseWord",function(c,d){b=c,a.message={which:"false_word",word:d,buttons:{"delete":!0}},a.immediate="dialogue"}),a.immediateStore.register("solvedCompletely",function(c){b=c,a.message={which:"solved_completely",buttons:{ok:!0}},a.immediate="dialogue"}),a.immediateStore.register("actionConfirmation",function(c,d){b=c,a.message=angular.extend(d,{buttons:{ok:!0,abort:!0}}),a.immediate="dialogue"}),a.$emit("immediateReady")}]);